"""
LLM-based exploit and proof-of-concept generation.
Independent from pyflow framework.
"""
from typing import Dict, List, Any, Optional
from dataclasses import dataclass
from .llm_utils import LLMClient, LLMConfig, format_code_snippet, retry_llm_call


@dataclass
class ExploitResult:
    """Result of exploit generation."""
    exploit_code: str
    poc_code: str
    explanation: str
    requirements: List[str]
    risk_level: str  # LOW, MEDIUM, HIGH, CRITICAL
    success: bool = True


class ExploitGenerator:
    """LLM-powered exploit and POC generation."""

    def __init__(self, llm_config: LLMConfig):
        self.llm_client = LLMClient(llm_config)
        self.exploit_prompt = """
        Generate an exploit and proof-of-concept for this vulnerability:

        Vulnerability: {vulnerability_description}
        Target System: {target_system}
        CWE: {cwe_id}

        Requirements:
        1. Provide working exploit code
        2. Include a safe proof-of-concept
        3. Explain how the exploit works
        4. List any dependencies or setup requirements

        Respond with JSON in this exact format:
        {
            "exploit_code": "full exploit code here",
            "poc_code": "safe proof-of-concept code",
            "explanation": "how this exploit works",
            "requirements": ["dependency1", "dependency2"],
            "risk_level": "LOW|MEDIUM|HIGH|CRITICAL"
        }

        Focus on educational purposes and include safety warnings.
        """

    @retry_llm_call(max_retries=2)
    def generate_exploit(self,
                        vulnerability_description: str,
                        target_system: str = "web application",
                        cwe_id: Optional[str] = None,
                        language: str = "python") -> ExploitResult:
        """Generate exploit and POC for a vulnerability."""

        prompt = self.exploit_prompt.format(
            vulnerability_description=vulnerability_description,
            target_system=target_system,
            cwe_id=cwe_id or "Unknown"
        )

        response = self.llm_client.call_simple(prompt)

        try:
            result = self._parse_exploit_response(response)

            return ExploitResult(
                exploit_code=result["exploit_code"],
                poc_code=result["poc_code"],
                explanation=result["explanation"],
                requirements=result["requirements"],
                risk_level=result["risk_level"],
                success=True
            )
        except (ValueError, KeyError) as e:
            return ExploitResult(
                exploit_code="",
                poc_code="",
                explanation=f"Failed to generate exploit: {e}",
                requirements=[],
                risk_level="LOW",
                success=False
            )

    def generate_from_judgment(self, judgment: Dict[str, Any], code_context: str = "") -> ExploitResult:
        """Generate exploit from bug judgment result."""
        vuln_desc = f"{judgment.get('explanation', '')} in {judgment.get('category', 'unknown')} vulnerability"

        return self.generate_exploit(
            vulnerability_description=f"{vuln_desc}\n\nCode Context:\n{code_context}",
            cwe_id=judgment.get('cwe_id')
        )

    def _parse_exploit_response(self, response: str) -> Dict[str, Any]:
        """Parse JSON response from LLM for exploit generation."""
        import json
        import re

        json_match = re.search(r'\{.*\}', response, re.DOTALL)
        if not json_match:
            raise ValueError("No JSON found in response")

        return json.loads(json_match.group())

    def generate_sql_injection_exploit(self, endpoint_url: str = "/api/user") -> ExploitResult:
        """Generate SQL injection exploit example."""
        vuln_desc = f"SQL injection vulnerability detected at {endpoint_url}"
        return self.generate_exploit(vuln_desc, cwe_id="CWE-89")

    def generate_xss_exploit(self, input_field: str = "search") -> ExploitResult:
        """Generate XSS exploit example."""
        vuln_desc = f"Cross-site scripting vulnerability in {input_field} field"
        return self.generate_exploit(vuln_desc, cwe_id="CWE-79")

    def generate_rce_exploit(self, function_name: str = "eval") -> ExploitResult:
        """Generate remote code execution exploit example."""
        vuln_desc = f"Remote code execution via {function_name} function"
        return self.generate_exploit(vuln_desc, cwe_id="CWE-78")
